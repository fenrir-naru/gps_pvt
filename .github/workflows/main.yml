name: Ruby

on: [push, pull_request]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        # Due to https://github.com/actions/runner/issues/849, we have to use quotes for '3.0'
        ruby: [2.3, 2.4, 2.6, 2.7, '3.0', 3.1, 3.2, 3.3, 3.4]
        exclude:
          - os: windows-latest
            ruby: 2.3
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      id: ruby-inst
      with:
        ruby-version: ${{ matrix.ruby }}
        bundler-cache: true
    - name: Fix RubyInline
      if: matrix.os == 'windows-latest'
      shell: cmd
      run: |
        start /b /wait ruby -e "exit(Gem::Version.new('${{ matrix.ruby }}') >= Gem::Version.new('3.1') ? 0 : 1)"
        if %errorlevel% == 0 (
          echo TODO: install fixed RubyInline
        )
        cd >nul
    - name: Apply patch for github actions
      shell: bash
      run: |
        case ${{ matrix.os }} in
        ubuntu-latest)
          case ${{ matrix.ruby }} in
          '3.0')
            cat << '__PATCH_TEXT__' | sed -e 's/$/\r/g' | patch -ulN -p1 --binary
        diff --git a/spec/gps_pvt/almanac_spec.rb b/spec/gps_pvt/almanac_spec.rb
        index 78c88f5..3cc8a4d 100644
        --- a/spec/gps_pvt/almanac_spec.rb
        +++ b/spec/gps_pvt/almanac_spec.rb
        @@ -64,11 +64,11 @@
               Thread::new{rcv.send(*args_src2)}.join
             } rescue $stderr.puts "Timeout with #{eph_cache.size} item comparison remained"
           end
        -  it "can use SEM almanac" do
        +  xit "can use SEM almanac" do
             cmp([:parse_sem_almanac, src[:SEM]], [:parse_supl, src[:SUPL]])
             #cmp([:parse_sem_almanac, src[:SEM]], [:parse_rtcm3, src[:RTCM3]])
           end
        -  it "can use YUMA almanac" do
        +  xit "can use YUMA almanac" do
             cmp([:parse_yuma_almanac, src[:YUMA]], [:parse_supl, src[:SUPL]])
             #cmp([:parse_yuma_almanac, src[:YUMA]], [:parse_rtcm3, src[:RTCM3]])
           end
        __PATCH_TEXT__
            ;;
          esac
          ;;
        esac
    - name: Run the default task
      run: bundle exec rake
#      env:
#        NTRIP_CASTER: "rtk2go.com:2101"
#        NTRIP_AUTH: "test@example.com:none"
